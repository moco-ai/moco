# Moco システム設計比較と Web UI 改良レポート

本レポートでは、旧Web基盤である `ai_manager` と現行の次世代オーケストレーター `moco` の設計思想を比較し、現在特定されている Moco Web UI の課題と具体的な改良案について詳述します。

---

## 1. マルチエージェントシステムの仕組み比較

### ai_manager (旧Web基盤)
`ai_manager` は、特定のWeb操作を自動化することに主眼を置いたシステムです。

- **設計思想**: **Tooling（操作の共通化）**に重点を置いています。エージェントが利用できるツールは事前に固定的に定義されており、それらをルールベースに基づいて呼び出す仕組みが強固です。
- **エージェントの役割**: 「ブラウザ操作担当」「スクレイピング担当」など、特定のWebスタックや操作に特化した役割が与えられます。柔軟な役割変更よりも、定義された手続きの正確な実行が重視されます。

### moco (現行世代オーケストレーター)
`moco` は、より抽象的で高度な**動的オーケストレーション**を実現するシステムです。

- **設計思想**: プロファイル (`profiles/`) システムによる**目的別のエージェント群の切り替え**が中核です。実行時にタスクの性質に応じて、必要な専門知識やツールセットを持つエージェント構成を動的にロードします。
- **主要な特徴**:
    - **MCP (Model Context Protocol) 統合**: 外部ツールサーバーとの標準化された連携により、拡張性が格段に向上しています。
    - **セッション永続化とチェックポイント**: 会話の状態を保存・復元可能で、長期的なタスク遂行に適しています。
    - **インサイト（リコール）機能**: FAISS を用いたセマンティックメモリにより、関連する過去の知識を自動的に想起し、コンテキストに注入します。

---

## 2. Moco Web UI のバグ・改良ポイント

現状の Moco Web UI において、開発およびユーザー体験の観点から以下の課題が特定されました。

### 特定されたバグ
- **コードハイライトの不整合**:
    - `formatter.js` では `highlight.js` (hljs) を使用してコードのクラスを `${lang} hljs` として生成していますが、`code_viewer.css` には Prism.js 形式の `.token` クラスが定義されています。これにより、一部の環境やビューアーでハイライトが正しく適用されない問題が発生しています。
- **テーマ切り替えの連動不全**:
    - グローバルなテーマ切り替え (`data-theme`) は実装されていますが、`code_viewer.mjs` を含む個別のコンポーネントや専用のコードビューアーがこの変更を検知してスタイルを動的に切り替える仕組みが不足しています。

### UX/UI 改良案
- **モバイル対応の強化**:
    - **インサイトパネル**: 画面右側のインサイトパネルを、モバイル表示時には下部から引き出す「ボトムシート」形式に変更し、情報の可視性と操作性を両立させます。
    - **サイドバー**: 画面を圧迫しないよう、モバイルではオーバーレイ（引き出し）形式をデフォルトとします。
- **インタラクションの向上**:
    - **送信ボタンの多機能化**: メッセージ生成中、送信ボタンを「停止（Stop）」ボタンに切り替え、長時間の生成をユーザーが制御できるようにします。
    - **トースト通知**: エラー発生時や重要アクションの完了（例：クリップボードへのコピー）時に、非破壊的なトースト通知を表示します。
    - **スクロールの安定化**: メッセージ追記時の自動スクロールを、ユーザーが手動でスクロールアップしている間は停止する「スマートスクロール」に改善します。
- **タイポグラフィの統一**:
    - コードおよびログ表示部において、可読性の高い `JetBrains Mono` を優先フォントとして適用し、開発者にとって違和感のない視覚体験を提供します。

---

## 3. 比較表：ai_manager vs moco

| 項目 | ai_manager (ベース) | moco (現行) |
| :--- | :--- | :--- |
| **アーキテクチャ** | 固定的なルールベース / ツール中心 | プロファイルベースの動的オーケストレーション |
| **拡張性** | 内部コードへのツール追加が必要 | プロファイル追加と MCP サーバー連携による容易な拡張 |
| **UI/UX** | 基本的なチャットインターフェース | セッション管理、インサイトパネル、テーマ対応 |
| **統合度 (MCP等)** | 非対応（独自実装のツール） | ネイティブ MCP 対応によるエコシステム統合 |
| **コンテキスト管理** | 単純な履歴保持 | 自動圧縮、セマンティック検索（RAG）による想起 |

---

## メンテナンス指針
- **システムの変更時**: `profiles/` の構造が変更された場合、本レポートの「仕組み」セクションを更新してください。
- **UI コンポーネントの更新時**: `Prism.js` から `highlight.js` への完全移行、またはその逆が行われた場合、バグセクションから内容を削除してください。
- **新機能追加時**: 比較表に「メモリ管理」や「マルチプロバイダ対応」などの詳細項目を追加し、進化を記録してください。
